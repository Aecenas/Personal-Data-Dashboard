# MyMetrics 项目续建计划（已执行版本）

> 更新时间：2026-02-13

## 1. 执行结果总览

本次已按“桌面端优先、Tauri 架构、本地 JSON 存储”的目标完成核心续建：

- 已补齐 `src-tauri` 并实现 Python 执行命令层。
- 已完成 4 步建卡向导与编辑复用。
- 已打通单卡刷新、全局刷新、启动/唤醒刷新、自动轮询。
- 已补齐 `status` 卡片、回收站清空、错误态详情与缓存回显。
- 已完成存储 schema 升级（`v0 -> v1` 自动迁移）。
- 已补基础测试与三平台 CI 打包流水线。

## 2. 已落地清单

### 2.1 执行引擎（Rust / Tauri）

- `run_python_script(request)`
- `validate_python_script(request)`
- 支持：
  - 可选解释器路径优先
  - 系统默认解释器回退策略
  - 超时熔断
  - `stdout/stderr/exit_code/duration_ms` 回传

关键文件：

- `src-tauri/src/commands.rs`
- `src-tauri/src/lib.rs`
- `src-tauri/Cargo.toml`

### 2.2 前端执行服务

- 新增 `services/execution.ts`：
  - `invoke` 调用 Rust 命令
  - JSON 解析与数据契约校验
  - scalar/series/status 映射转换
  - 错误信息归一化

### 2.3 Store 与状态机

- `store.ts` 新增动作：
  - `refreshCard`
  - `refreshAllCards`
  - `updateCard`
  - `clearRecycleBin`
- 统一运行状态：`idle/loading/success/error`
- 加入并发保护：同一卡片刷新互斥
- 启动优先回显缓存数据

### 2.4 向导与管理 UI

- `CreationWizard.tsx` 升级为 4 步：
  1. 基础信息
  2. 数据源
  3. 映射配置
  4. 测试预览
- 支持编辑模式复用同一向导。
- 支持脚本参数、解释器路径、刷新策略、超时设置。
- 支持运行测试并展示 raw stdout/stderr 与预览。

### 2.5 Dashboard / 卡片 / 回收站

- Dashboard：全局刷新、编辑入口、拖拽保持。
- CardShell：菜单接通刷新/编辑/删除，错误详情与最后刷新时间展示。
- 新增 `StatusCard.tsx`。
- 回收站：新增清空回收站与二次确认。

### 2.6 存储迁移

- `services/storage.ts` 新增：
  - `schema_version: 1`
  - `migrateToV1`
  - 旧 mapping/runtime 字段兼容迁移

### 2.7 工程质量与交付

- 新增测试：
  - `services/execution.test.ts`
  - `services/storage.test.ts`
- 新增 CI：`.github/workflows/desktop-ci.yml`
  - 前端 typecheck + test + build
  - macOS / Windows / Linux Tauri 打包矩阵

## 3. 数据模型（已定版）

- `CardType`: `scalar | series | status`
- `ScriptConfig`: `path`, `args`, `env_path?`
- `MappingConfig`: 按类型拆分
- `RefreshConfig`: `interval_sec`, `refresh_on_start`, `refresh_on_resume`, `timeout_ms`
- `CacheData`: 持久化成功数据与错误摘要
- `status.sort_order`: 排序索引

## 4. 验证结果

本地已通过：

- `npm run typecheck`
- `npm run test -- --run`
- `npm run build`

## 5. 已知限制

- 当前开发环境未安装 Rust toolchain，尚未在本机实际执行 `tauri dev/build`。
- 三平台打包依赖平台级工具链，需在 CI 或对应系统环境中完成最终验收。

## 6. 下一步建议

1. 在本机安装 Rust 后执行 `npm run tauri:dev`，验证真实脚本调用。
2. 用 3 份示例脚本（scalar/series/status）逐项跑验收清单。
3. 在 CI 首轮跑通后，补充失败场景截图与用户操作说明。
