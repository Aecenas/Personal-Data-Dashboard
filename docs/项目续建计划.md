# MyMetrics 项目续建计划（基于 PRD v1.0.0）

## 1. 需求审查（PRD 关键信息拆解）

基于 `docs/产品需求文档 (PRD).md`，项目目标是一个“UI 与数据逻辑解耦”的个人数据看板：

- UI 侧负责：卡片展示、分组、排序、编辑、删除、回收站、刷新调度。
- 用户侧负责：提供本地 Python 脚本输出 JSON。
- 执行引擎负责：子进程调用、超时熔断、错误捕获与回传。

### 1.1 必须落地的功能范围（按 PRD）

1. **Dashboard 模块**
   - 分组导航（全部/按组）
   - 多类型卡片渲染（scalar/series/status）
   - 加载态、错误态、缓存回显
   - 拖拽排序
   - 卡片编辑（复用创建向导）
   - 软删除（进入回收站）
   - 手动刷新 + 自动刷新（启动/唤醒/轮询）

2. **Card Management 模块**
   - 新建向导 4 步：基础信息 → 数据源绑定 → 映射配置 → 测试预览
   - 回收站：列表、还原、彻底删除、清空

3. **Execution Engine 模块**
   - 子进程运行 Python
   - 默认超时熔断（例如 10 秒）
   - 捕获 stderr / exit code / JSON parse 错误并反馈到卡片

4. **数据协议与存储**
   - 严格 JSON contract（`type` + `data`）
   - 本地 JSON/SQLite 存储卡片配置
   - 卡片对象需包含脚本配置、映射配置、UI 配置、删除状态、排序信息

### 1.2 需求中的高风险点

- **运行环境矛盾**：PRD 要求“本地 Python 子进程调用”，当前前端项目没有后端执行层。
- **多端范围偏大**：PRD含“桌面 + 移动端建议 C/S”；现阶段应先收敛到桌面端 MVP。
- **映射配置复杂性**：系列图和状态卡对 mapping 要求更细，不应直接把脚本输出硬编码到 UI。

---

## 2. 当前 main 分支代码审查

> 结论：当前是“高保真 UI 原型 + 本地持久化雏形”，距离 PRD 的可用产品仍有较大差距。

### 2.1 已完成（与 PRD 对齐项）

- 有 Dashboard 主视图、分组筛选和基础卡片渲染（scalar/series 两类）。
- 有拖拽布局（基于网格坐标）和编辑模式。
- 有创建向导 UI（3 步简化版）。
- 有回收站视图，支持还原与永久删除。
- 有软删除字段（`is_deleted`, `deleted_at`）并落在 store/card 模型中。
- 有 Tauri 文件存储适配与设置页“数据路径”选择。

### 2.2 未完成 / 与 PRD 不一致

1. **执行引擎缺失（核心缺口）**
   - 无 Python 子进程调度能力。
   - 无超时控制、stderr 回传、exit code 处理。
   - 卡片数据目前来自 mock 或创建时注入的假数据。

2. **刷新体系缺失**
   - 无全局刷新/单卡刷新。
   - 无自动轮询、应用启动/唤醒触发刷新。

3. **创建向导功能不足**
   - 未覆盖 PRD 的 4 步完整流程。
   - 缺少解释器路径、脚本参数编辑。
   - 缺少 mapping 配置（value/x/y 等 key 映射）。
   - 第 3 步“测试预览”为静态占位，不是真实脚本测试。

4. **卡片管理能力不足**
   - 缺少卡片编辑入口（复用向导）。
   - 缺少排序索引持久化（当前依赖 x/y）。
   - 回收站缺少“清空回收站”。

5. **数据契约与类型不完整**
   - `status` 类型在类型系统和 UI 中不完整。
   - `mapping_config` 结构未被实际消费。
   - `runtimeData` 没有完整生命周期（loading/error/cached timestamp）。

6. **存储层风险**
   - 当前仅在 Tauri 环境读写；非 Tauri 下 load/save 基本不可用（内存态）。
   - 默认演示数据从 mock 初始化，不符合“读取上次缓存优先展示”的产品语义。

### 2.3 工程风险与建议

- 需要先明确 **技术路线**：
  - A 方案：Tauri + Rust command 调 Python（推荐，符合桌面端目标）
  - B 方案：Node sidecar 执行（实现快，但部署复杂）
- 建议先做 **桌面 MVP**，暂不推进移动端 C/S。
- 需要补充 **测试基线**：最少覆盖 store、执行服务、数据映射与错误场景。

---

## 3. 续建实施计划（建议 5 个迭代）

## Iteration 0：基线修正（1~2 天）

**目标**：把项目从“原型态”转为“可持续开发态”。

- 输出 `ARCHITECTURE.md`：明确前端层 / 执行层 / 存储层边界。
- 统一 card 模型：补齐 `status` 卡片类型、`sort_order`、刷新配置字段。
- 为 `runtimeData` 定义统一状态机：`idle/loading/success/error`。
- 加入基础质量门禁：`npm run build`、`tsc --noEmit`（或统一到 build）。

**验收标准**：类型定义与状态流稳定，后续开发不反复改模型。

## Iteration 1：执行引擎 MVP（3~5 天）

**目标**：打通“脚本可运行、错误可见、结果可用”。

- 在 Tauri 侧实现命令：
  - 输入：`script_path`, `args`, `python_path?`, `timeout_ms`
  - 输出：`stdout`, `stderr`, `exit_code`, `duration_ms`
- 前端封装 `executionService`：
  - JSON 解析、数据契约校验
  - 失败时写入卡片 `error`
- 卡片支持真实加载态/错误态显示。

**验收标准**：任意卡片可单独执行脚本并正确展示成功或错误结果。

## Iteration 2：创建向导与映射配置（3~4 天）

**目标**：把“新增卡片”做成可用生产功能。

- 向导改为 4 步：基础信息 → 数据源 → 映射 → 测试预览。
- 支持字段：解释器路径、参数列表、刷新频率、颜色主题、尺寸。
- 映射配置 UI：
  - scalar: value/unit/trend/color 映射
  - series: x/series.name/series.values 映射
  - status: label/state 映射
- 测试预览调用真实执行引擎并渲染预览。

**验收标准**：用户可通过向导创建“真实可运行”的卡片。

## Iteration 3：Dashboard 运营能力（3~4 天）

**目标**：满足 PRD 的日常使用体验。

- 全局刷新、单卡刷新按钮。
- 自动刷新调度（按卡片频率，后台轮询）。
- 启动时先展示缓存，再异步刷新。
- 卡片编辑入口（复用向导）、软删除反馈 toast。
- 回收站补齐“清空回收站”。

**验收标准**：用户日常管理卡片闭环完成。

## Iteration 4：稳定性与发布准备（2~3 天）

**目标**：达到可交付质量。

- 异常场景测试：超时、非 JSON 输出、脚本退出码非 0、字段缺失。
- 存储迁移与兼容：版本号、向前兼容。
- 文档完善：脚本编写指南、数据契约示例、故障排查。
- 打包验证：Windows/macOS/Linux（至少主开发平台 + 1 目标平台）。

**验收标准**：可对外给测试用户试用。

---

## 4. 任务拆分优先级（P0 / P1 / P2）

### P0（必须先做）

- 执行引擎（运行、超时、错误）
- 创建向导真实测试与映射
- 刷新体系（手动 + 自动）
- 缓存优先展示 + 异步更新

### P1（建议随后）

- status 卡片 UI
- 编辑卡片
- 回收站清空
- 统一错误提示与观测日志

### P2（可延后）

- 移动端 C/S 扩展
- SQLite 替换 JSON（若规模增长）
- 更高级布局算法与性能优化

---

## 5. 里程碑与交付物

- **M1（执行闭环）**：可运行真实 Python 并显示结果/错误。
- **M2（生产闭环）**：可创建、测试、保存、刷新卡片。
- **M3（日常可用）**：编辑、删除、回收站、缓存、自动刷新完善。
- **M4（发布准备）**：稳定性测试和文档齐备。

---

## 6. 建议的“下一步立即行动清单”（本周）

1. 先确认执行引擎技术路线（Tauri command）。
2. 新增 `executionService` 前端接口与类型。
3. 改造 Creation Wizard 为 4 步并接入“运行测试”。
4. 给 Dashboard 增加单卡刷新按钮，打通从 UI 到执行引擎的第一条链路。
5. 补充最小测试：
   - 解析成功
   - 超时失败
   - 非 JSON 失败
   - Exit Code 失败

> 完成以上 5 项后，项目会从“半成品 UI 原型”进入“可迭代产品内核”阶段。
