# 产品需求文档 (PRD)

| 项目名称 | MyMetrics - 个人数据看板 |
| --- | --- |
| 对齐版本 | v0.2.0（按当前代码实现重写） |
| 文档状态 | 已重写（2026-02-17） |
| 适用端 | 桌面端（Tauri：macOS / Windows / Linux） |

## 1. 产品概述

### 1.1 背景

个人常用数据（健康、资产、效率、系统状态、内容摘要等）分散在本地脚本、命令行工具与第三方接口中。用户希望以统一看板方式查看结果，但不希望把数据上云，也不希望被固定数据模型限制。

### 1.2 产品定位

MyMetrics 是一款**本地优先、脚本驱动**的桌面数据看板：

- 用户负责：编写本地 Python 脚本输出 JSON。
- 应用负责：执行调度、映射归一化、可视化展示、告警通知、诊断统计、配置持久化与备份。

### 1.3 产品目标

- 让用户在 5 分钟内完成首张卡片创建并成功展示数据。
- 让数据更新、失败诊断、告警通知形成闭环。
- 保证配置可迁移、可备份、可导入导出，避免因版本升级造成配置损坏。

## 2. 术语定义

- 卡片（Card）：看板最小展示单元，绑定一个脚本与一套映射。
- 分组（Group）：卡片与分段线的业务分区。
- 分段线（Section Marker）：在组内网格中按行插入视觉分隔。
- 回收站（Recycle Bin）：软删除卡片的临时容器。
- 执行历史（Execution History）：每张卡片的环形执行记录（成功/失败/耗时/错误摘要）。
- 缓存数据（Cache Data）：最近一次成功结果及最近失败元数据，用于失败兜底展示。

## 3. 功能需求

### 3.1 Dashboard 看板

#### 3.1.1 视图与筛选

- 仅展示当前激活分组（`activeGroup`）且未删除（`is_deleted=false`）的卡片。
- 支持 5 类卡片：`scalar`、`series`、`status`、`gauge`、`digest`。
- 支持分段线渲染，按 `after_row/start_col/span_col` 控制位置与跨度。

#### 3.1.2 卡片状态与交互

- 状态流转：`idle -> loading -> success/error`。
- 成功后写入 `cache_data.last_success_payload` 与 `runtimeData`。
- 失败时保留上次成功 payload 展示（若存在），并显示错误摘要。
- 卡片菜单支持：单卡刷新、编辑、复制、查看执行历史、软删除。
- `digest` 卡片内容溢出时支持双击打开 Markdown 预览弹窗。

#### 3.1.3 布局编辑

- 支持编辑模式开关。
- 支持方向键移动卡片。
- 单步移动遇到同尺寸卡片时可交换位置；异尺寸时尝试跨越到合法空位。
- 移动与缩放后需保证：不越界、不重叠、排序稳定。

#### 3.1.4 刷新机制

- 手动刷新：支持全量刷新与单卡刷新。
- 自动刷新：
  - 应用初始化后按卡片 `refresh_on_start` 刷新。
  - 窗口焦点恢复/页面可见时按 `refresh_on_resume` 刷新。
  - 按卡片 `interval_sec` 定时刷新（`0` 表示关闭）。
- 刷新执行使用全局并发队列，最大并发受 `refresh_concurrency_limit` 控制。

### 3.2 Creation Wizard（新建/编辑向导）

#### 3.2.1 步骤结构（5 步）

1. 基础信息：标题、分组、卡片类型、尺寸、视觉主题与展示细节。
2. 脚本与刷新：脚本路径、参数字符串、解释器路径、刷新策略、超时。
3. 字段映射：按卡片类型配置 key（支持点路径）。
4. 告警：按类型配置状态变化/内容变化/阈值策略与 cooldown。
5. 测试预览：执行脚本，展示预览与原始 stdout/stderr。

#### 3.2.2 校验规则

- 脚本路径必填且必须以 `.py` 结尾。
- 参数字符串按 shell-like 规则拆分，未闭合引号报 `UNCLOSED_QUOTE`。
- timeout 最小 `1000ms`。
- 映射字段按卡片类型进行必填校验。
- 告警阈值需为数字，且 `lower <= upper`（若两者同时设置）。
- Step 2 需通过脚本预校验（文件存在 + 解释器可用）才能继续。

### 3.3 分组管理中心（Group Management Center）

#### 3.3.1 分组管理

- 创建分组、重命名分组、排序分组、删除分组。
- `All` 为保留名，不可创建/重命名为该值。
- 删除分组时：若组内有卡片/分段线，必须指定迁移目标组。
- 至少保留 1 个分组。

#### 3.3.2 批量操作

- `move_group`：将选中卡片/分段线迁移到目标分组。
- `update_interval`：批量更新选中卡片刷新间隔。
- `update_script_path_prefix`：保留文件名，仅替换脚本路径前缀。
- `soft_delete`：批量软删除选中卡片并移除选中分段线。

### 3.4 回收站

- 列出软删除卡片：标题、原分组、删除时间。
- 支持单张恢复：恢复后重新分配组内与全局布局位置。
- 支持单张永久删除。
- 支持清空回收站（永久删除全部软删除卡片）。

### 3.5 诊断中心（Diagnostics）

- 汇总所有可见卡片的执行历史，支持按卡片与状态筛选。
- 输出统计指标：`total/success_count/failure_count/success_rate/average/p50/p90`。
- 提供失败热点排行与最近失败时间。
- 支持分页浏览最近执行记录。
- 每张卡片支持独立历史弹窗查看明细。

### 3.6 设置中心（Settings）

#### 3.6.1 通用

- 主题：`light/dark`。
- 语言：`zh-CN/en-US`。
- 看板列数：`2~6`。
- 自适应窗口开关。

#### 3.6.2 存储与备份

- 数据目录切换（默认 AppLocalData，支持自定义目录）。
- 配置导入/导出 JSON。
- 手动备份。
- 自动备份：
  - 模式：`interval/daily/weekly`
  - 保留份数：`3~20`
  - 备份目录支持迁移（可搬运历史备份文件）

#### 3.6.3 运行时

- 默认 Python 解释器。
- 刷新并发上限：`1~16`。
- 执行历史容量：`10~500`。
- 交互音效开关与音量（`0~100`）。

#### 3.6.4 通知

- 桌面通知总开关。
- 通知权限申请。
- 发送测试通知。
- 告警通知由卡片刷新成功后的告警评估触发。

### 3.7 执行引擎（Tauri + Rust）

- 暴露命令：`run_python_script`、`validate_python_script`。
- 解释器选择优先级：
  1. 卡片级 `python_path`
  2. 全局 `default_python_path`
  3. 平台兜底（Windows: `python -> py -3`，其他平台: `python3 -> python`）
- 执行超时统一 clamp 到 `1000ms ~ 120000ms`。
- 响应返回：`stdout/stderr/exit_code/timed_out/duration_ms`。

## 4. 数据协议与归一化

- 脚本协议见：`docs/脚本数据协议与示例.md`。
- 协议根结构固定为：

```json
{
  "type": "scalar | series | status | gauge | digest",
  "data": {}
}
```

- `type` 必须与卡片类型一致。
- 映射支持点路径（如 `metrics.cpu.value`）。
- 状态别名归一化：
  - `success/healthy -> ok`
  - `warn -> warning`
  - `critical/danger -> error`

## 5. 数据模型与持久化

### 5.1 持久化对象

- 主对象：`AppSettings`。
- 当前 schema：`schema_version = 8`。
- 核心实体：`groups`、`cards`、`section_markers`、`backup_config`、`interaction_sound`。

### 5.2 存储位置

- 默认：`AppLocalData/data/user_settings.json`。
- 自定义目录：通过 `AppLocalData/storage_config.json` 记录指针。
- 备份目录默认：`data/backups/`（可改）。

### 5.3 迁移与规范化

- 启动时统一迁移到最新 schema。
- 会执行字段补齐、范围 clamp、旧结构兼容转换。
- 会自动规范化分组、分段线、布局作用域、执行历史容量。
- 卡片业务编号格式：`G{groupNumber}-C{cardNumber}`，由系统自动维护唯一性。

## 6. 非功能需求

### 6.1 性能

- 刷新队列并发受限，防止高并发卡顿。
- 所有脚本执行异步，不阻塞 UI 主线程。
- 自动保存使用防抖，避免高频磁盘写入。

### 6.2 可靠性

- 执行失败不抹掉最后成功数据。
- 执行历史采用 ring buffer，容量可控。
- 备份支持保留策略与自动清理过期备份。

### 6.3 可维护性

- 关键行为由 `services/*.test.ts` 覆盖。
- CI 包含类型检查、单测、前端构建与多平台 Tauri 构建。

## 7. 安全与边界

- 脚本按当前用户权限执行，不提供额外沙箱隔离。
- 应用只校验脚本路径合法性与解释器可用性，不审计脚本业务逻辑安全。

## 8. 当前不在范围内（Out of Scope）

- 移动端 App。
- 云端同步与多用户协作。
- 远程脚本托管/在线执行。

## 9. 验收标准（Release Gate）

- 可在桌面端完成从新建卡片到成功刷新的完整闭环。
- 刷新失败场景可复现并可定位（错误信息、stderr、历史记录完整）。
- 告警通知、回收站、分组批处理、导入导出、备份调度均可用。
- 导入旧版本配置可自动迁移到 schema v8，且不丢失核心配置。
