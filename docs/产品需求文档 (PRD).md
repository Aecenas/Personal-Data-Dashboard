```yaml
# 产品需求文档 (PRD)

| 项目名称 | MyMetrics - 个人数据看板        |
|:---- |:------------------------- |
| 版本号  | v1.0.0 (Release)          |
| 文档状态 | **已定稿**                   |
| 适用端  | 桌面端 (Windows) + 移动端 (App) |
```

## 1. 产品概述 (Product Overview)

### 1.1 背景与痛点

作为具有技术背景的个人用户，日常关注的数据（如健康指标、金融持仓、特定网站热度、服务器状态等）高度分散且异构。市面上的通用看板无法满足用户对“特定计算逻辑”和“高度定制化”的需求。用户需要一个能够集中展示这些零散数据的工具，且数据的所有权和计算逻辑应完全由用户掌控。

### 1.2 产品定位

一款**“UI与数据逻辑解耦”**的个人数据聚合工具。

- **应用职责**：负责UI渲染、布局管理、脚本调度。
- **用户职责**：编写本地 Python 脚本作为数据源。

---

## 2. 核心概念定义 (Terminology)

- **卡片 (Card)**：数据展示的最小单元，承载一个具体的指标或图表。
- **脚本 (Script)**：位于用户本地文件系统的 Python 文件 (`.py`)，是数据的生产者。
- **分组 (Group)**：卡片的分类标签（如：健康、理财、工作），用于聚合展示。
- **回收站 (Recycle Bin)**：存放已被用户从看板移除、但尚未彻底销毁配置的卡片容器。

---

## 3. 功能需求详解 (Functional Requirements)

### 3.1 模块一：仪表盘视图 (Dashboard View)

**核心职责**：数据的展示消费、卡片的日常管理（排序/编辑/软删除）。

#### 3.1.1 视图展示与导航

- **分组导航**：
  - 顶部/侧边栏展示“分组标签（Tabs）”。
  - 支持切换“全部”或“特定分组”。点击某分组，仅渲染属于该组的卡片。
- **卡片渲染**：
  - 支持多种可视化类型：纯数字指标、折线图、柱状图、饼图、状态仪表盘（红绿灯）。
  - **加载状态**：脚本执行期间，卡片显示骨架屏或Loading动画。若脚本执行失败（Exit Code非0或JSON解析失败），卡片显示红色错误状态及简要报错信息（Stderr）。
  - **缓存机制**：应用启动时，优先展示上一次成功获取的缓存数据（标记时间戳），待脚本执行完成后更新为新数据。

#### 3.1.2 交互与管理 (直接操作)

- **卡片排序 (Sort)**：支持拖拽（Drag & Drop）调整卡片顺序。
- **卡片编辑 (Edit)**：
  - 在卡片上提供“设置”入口。
  - 点击后复用“新建卡片”的配置弹窗，允许修改标题、颜色、脚本参数、刷新频率等。
- **软删除 (Soft Delete)**：
  - 在卡片上提供“删除”入口。
  - 操作反馈：点击后，卡片从仪表盘立即消失，并弹出轻提示“卡片已移至回收站”。
  - **逻辑**：仅将数据库中该卡片的 `is_deleted` 标记置为 `true`，**不物理删除配置**。

#### 3.1.3 数据刷新

- **手动刷新**：支持全局刷新所有卡片，或单卡片独立刷新。
- **自动刷新**：
  - 应用启动/唤醒时触发。
  - 支持按设定的时间间隔（Crontab或简单轮询）自动后台刷新。

---

### 3.2 模块二：卡片管理中心 (Card Management Center)

**核心职责**：新卡片的生产车间、误删卡片的后悔药。

#### 3.2.1 新建卡片向导 (Creation Wizard)

提供清晰的分步流程，创建成功后卡片自动追加到仪表盘。

1. **基础信息**：输入卡片标题、选择/新建分组、选择卡片UI类型（数字/图表）。
2. **绑定数据源**：
   - 选择本地 Python 脚本路径。
   - (可选) 设置 Python 解释器路径（venv支持）。
   - (可选) 输入传递给脚本的命令行参数。
3. **数据映射 (Mapping)**：
   - 根据选定的UI类型，配置 JSON 字段映射。
   - 例 - 纯数字卡：需配置 Value Field（对应JSON中的key）。
   - *例：折线图需配置 `x_field` 和 `y_field` 对应的 JSON Key。*
4. **测试与预览 (Test)**：
   - 点击“运行测试”，应用调用脚本并展示原始 JSON 输出。
   - 若解析成功，实时渲染卡片预览图。

#### 3.2.2 回收站 (Recycle Bin)

- **列表展示**：显示所有 `is_deleted = true` 的卡片。
  - 展示信息：卡片标题、原所属分组、删除时间。
- **还原 (Restore)**：
  - 点击还原，将 `is_deleted` 置为 `false`。
  - 卡片重新出现在仪表盘（原分组末尾）。
- **彻底删除 (Hard Delete)**：
  - 用户二次确认后，从本地存储中彻底清除该卡片的配置数据。
- **清空回收站**：一键物理删除所有回收站内的卡片。

---

### 3.3 模块三：后台执行引擎 (Execution Engine)

**核心职责**：不可见的后端逻辑，负责连接 UI 与 Python。

- **进程调用**：使用子进程 (Subprocess) 调用 Python 执行脚本。
- **超时熔断**：设置脚本默认执行超时时间（如 10秒）。超时强制 Kill 进程并返回错误状态。
- **错误捕获**：
  - 若 Exit Code != 0 或 JSON 解析失败，卡片UI变为“错误态”。
  - 错误态需展示 `stderr` 或异常信息方便调试。

---

## 4. 数据交互协议 (Data Contract)

应用与脚本之间通过 **标准输出 (STDOUT)** 进行通信，格式严格限制为 **JSON**。

### 4.1 基础结构

脚本必须输出如下 JSON 结构：

```json
{
  "type": "scalar | series | status", // 数据类型枚举
  "data": { ... } // 具体负载
}
```

### 4.2 场景示例

**场景 A：纯数字 (Scalar)**
*用于展示：今日药量、气温、股票现价*

```json
{
  "type": "scalar",
  "data": {
    "value": 24.5,
    "unit": "℃",
    "trend": "up",      // 可选：up/down/flat，用于显示箭头
    "color": "success"  // 可选：success/warning/danger
  }
}
```

**场景 B：序列数据 (Series)**
*用于展示：股价走势、历史温度（折线图/柱状图）*

```json
{
  "type": "series",
  "data": {
    "x_axis": ["10:00", "11:00", "12:00"],
    "series": [
      { "name": "价格", "values": [100, 102, 101] }
    ]
  }
}
```

---

## 5. 数据存储结构 (Storage Schema)

建议使用本地 JSON 文件或 SQLite 存储卡片配置。

**Card Object 模型设计：**

```json
{
  "id": "uuid_v4_string",
  "title": "我的卡片名称",
  "group": "默认分组",
  "type": "line_chart",
  "script_config": {
    "path": "/Users/name/scripts/weather.py",
    "args": ["--city", "beijing"],
    "env_path": "/usr/bin/python3"
  },
  "mapping_config": {
    "x_key": "time",
    "y_key": "temp"
  },
  "ui_config": {
    "color_theme": "blue",
    "size": "2x1"
  },
  "status": {
    "is_deleted": false,      // 软删除标记
    "deleted_at": null,       // 删除时间
    "sort_order": 1           // 排序索引
  }
}
```

---

## 6. 非功能性需求 (NFR)

1. **安全性**：应用需具备读取本地文件的系统权限；在执行脚本时，建议进行基本的路径合法性校验。
2. **性能**：脚本执行必须是**异步非阻塞**的，禁止脚本卡死主界面 UI。
3. **兼容性**：
   - 桌面端：支持 Windows 10/11, macOS, Linux。
   - 移动端（若开发）：建议架构为 C/S 模式，桌面端作为 Server 负责跑脚本，手机端仅请求桌面端接口获取 JSON 结果。
