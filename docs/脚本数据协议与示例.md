# 脚本数据协议与示例

MyMetrics 通过执行本地 Python 脚本获取数据。脚本必须将 JSON 输出到 `stdout`。

## 通用结构

```json
{
  "type": "scalar | series | status",
  "data": {}
}
```

## 1. Scalar 示例

适用于单值指标，例如 CPU、温度、余额。

```python
import json

print(json.dumps({
    "type": "scalar",
    "data": {
        "value": 42.5,
        "unit": "%",
        "trend": "up",
        "color": "warning"
    }
}, ensure_ascii=False))
```

可选字段：

- `trend`: `up | down | flat`
- `color`: `success | warning | danger | neutral`

## 2. Series 示例

适用于时序或分类序列图。

```python
import json

print(json.dumps({
    "type": "series",
    "data": {
        "x_axis": ["10:00", "11:00", "12:00"],
        "series": [
            {
                "name": "CPU",
                "values": [23, 35, 31]
            }
        ]
    }
}, ensure_ascii=False))
```

## 3. Status 示例

适用于状态类卡片，例如服务健康、告警状态。

```python
import json

print(json.dumps({
    "type": "status",
    "data": {
        "label": "db-primary",
        "state": "ok",
        "message": "replication lag normal"
    }
}, ensure_ascii=False))
```

`state` 推荐值：`ok | warning | error | unknown`

## 常见错误

1. 非 JSON 输出
- 现象：卡片报“脚本输出不是合法 JSON”。
- 处理：确保 stdout 只有 JSON，不要混入日志。

2. type 与卡片类型不一致
- 现象：卡片报“脚本输出类型与卡片类型不一致”。
- 处理：检查 `type` 字段是否匹配当前卡片。

3. 字段映射错误
- 现象：卡片报“字段映射失败”。
- 处理：检查向导第 3 步映射 key，支持点路径（如 `metrics.cpu.value`）。

4. 超时
- 现象：卡片报“脚本执行超时”。
- 处理：优化脚本耗时或调大卡片超时配置（毫秒）。

5. 解释器找不到
- 现象：卡片报解释器不可用或路径无效。
- 处理：
  - 优先使用卡片级解释器路径。
  - 或在 Settings 设置默认解释器。
  - 否则使用系统默认命令（macOS/Linux: `python3`，Windows: `python`/`py -3`）。
