# 脚本数据协议与示例

MyMetrics 通过执行本地 Python 脚本获取数据。脚本必须将 JSON 输出到 `stdout`。

## 通用结构

```json
{
  "type": "scalar | series | status | gauge | digest",
  "data": {}
}
```

补充约束：

- `type` 必须是字符串，并且要与卡片类型一致。
- `data` 字段必须存在。

## 1. Scalar 示例

适用于单值指标，例如 CPU、温度、余额。

```python
import json

print(json.dumps({
    "type": "scalar",
    "data": {
        "value": 42.5,
        "unit": "%",
        "trend": "up",
        "color": "warning"
    }
}, ensure_ascii=False))
```

可选字段：

- `trend`: `up | down | flat`
- `color`: `success | warning | danger | neutral`

## 2. Series 示例

适用于时序或分类序列图。

```python
import json

print(json.dumps({
    "type": "series",
    "data": {
        "x_axis": ["10:00", "11:00", "12:00"],
        "series": [
            {
                "name": "CPU",
                "values": [23, 35, 31]
            }
        ]
    }
}, ensure_ascii=False))
```

Series 卡片支持 3 种显示子模式（由卡片配置决定，不改变脚本协议）：

- `single_axis_single_line`：只绘制第 1 条序列（左侧 Y 轴）
- `single_axis_double_line`：绘制前 2 条序列（共用左侧 Y 轴，显示图例）
- `dual_axis_double_line`：绘制前 2 条序列（分别使用左右 Y 轴，显示图例）

补充规则：

- 双线模式固定使用 `series[0]` 和 `series[1]`。
- 若卡片配置为双线但脚本仅返回 1 条序列，会自动回退为单线渲染。
- 历史老卡迁移时，若前两条序列取值范围比 `>= 3x`，会自动迁移为双轴双线，否则迁移为单轴双线。

## 3. Status 示例

适用于状态类卡片，例如服务健康、告警状态。

```python
import json

print(json.dumps({
    "type": "status",
    "data": {
        "label": "db-primary",
        "state": "ok",
        "message": "replication lag normal"
    }
}, ensure_ascii=False))
```

`state` 推荐值：`ok | warning | error | unknown`

兼容别名会被自动归一化：

- `success/healthy -> ok`
- `warn -> warning`
- `critical/danger -> error`

## 4. Gauge 示例

适用于带上下限的仪表盘类指标。

```python
import json

print(json.dumps({
    "type": "gauge",
    "data": {
        "min": 0,
        "max": 100,
        "value": 80,
        "unit": "%"
    }
}, ensure_ascii=False))
```

字段说明：

- `min`: 下限（数字）
- `max`: 上限（数字，必须大于 `min`）
- `value`: 当前值（数字）
- `unit`: 可选单位

## 5. Digest 示例

适用于“标题 + 正文”分组文本场景，例如每日新闻摘要。

```python
import json

print(json.dumps({
    "type": "digest",
    "data": {
        "items": [
            {
                "title": "OpenAI 发布新模型能力",
                "body": "支持更稳定的工具调用，并提升了长上下文任务表现。"
            },
            {
                "title": "市场动态",
                "body": "- 纳斯达克上涨 0.8%\\n- AI 概念股成交活跃"
            }
        ]
    }
}, ensure_ascii=False))
```

字段说明：

- `items`: 数组（必填）
- `items[].title`: 标题（必填）
- `items[].body`: 正文（必填，支持 markdown 文本）

## 执行与校验补充规则

- `stdout` 必须只输出 JSON；调试日志请写到 `stderr` 或文件。
- 映射 key 支持点路径（如 `metrics.cpu.value`）。
- 脚本路径校验要求：文件必须存在且扩展名为 `.py`。
- 实际执行超时会被限制在 `1000ms ~ 120000ms`。
- 解释器选择顺序：
  - 卡片级解释器路径
  - Settings 中默认解释器路径
  - 平台兜底（macOS/Linux: `python3 -> python`，Windows: `python -> py -3`）

## 常见错误

1. 非 JSON 输出
- 现象：卡片报“脚本输出不是合法 JSON”。
- 处理：确保 stdout 只有 JSON，不要混入日志。

2. type 与卡片类型不一致
- 现象：卡片报“脚本输出类型与卡片类型不一致”。
- 处理：检查 `type` 字段是否匹配当前卡片。

3. 字段映射错误
- 现象：卡片报“字段映射失败”。
- 处理：检查向导第 3 步映射 key，支持点路径（如 `metrics.cpu.value`）。

4. 超时
- 现象：卡片报“脚本执行超时”。
- 处理：优化脚本耗时或调大卡片超时配置（毫秒，最终会 clamp 到 `1000~120000`）。

5. 解释器找不到
- 现象：卡片报解释器不可用或路径无效。
- 处理：
  - 优先使用卡片级解释器路径。
  - 或在 Settings 设置默认解释器。
  - 否则使用系统默认命令（macOS/Linux: `python3`，Windows: `python`/`py -3`）。
